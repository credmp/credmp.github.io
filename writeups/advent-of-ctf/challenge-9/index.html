<!DOCTYPE html>
<html lang="en">
<head>
<!-- 21 Dec. 2022 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advent of CTF - Challenge 9</title>
<meta name="author" content="Arjen Wiersma" />
<meta name="generator" content="Org Mode" />
<meta description='Writings by Arjen'/>
<link rel='alternate' type='application+rss/xml' title='Writings by Arjen' href='/posts/rss.xml'/>
<link rel="stylesheet" href="../../../css/theme.css?v=20216e086cf8a20ead56908f3be0bcda6af2531ec1a68c9058ee7495590f57ea" type="text/css">
</head>
<body>
<main id="content" class="content">
<header>
<h1 class="title">Advent of CTF - Challenge 9</h1>
<p class="subtitle" role="doc-subtitle">&ldquo;JWT&rdquo;</p>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0e28f35">Challenge</a></li>
<li><a href="#org3d993ce">Solution</a></li>
</ul>
</div>
</nav>

<section id="outline-container-org0e28f35" class="outline-2">
<h2 id="org0e28f35">Challenge</h2>
<div class="outline-text-2" id="text-org0e28f35">
<p>
This has an added layer of complexity. There are several rabbit holes and a non-trivial bypass. What you will learn:
</p>

<ul class="org-ul">
<li>Read error messages</li>
<li>Identify JSON structures in Base64</li>
<li>JSON Web Tokens (JWT) and the NONE algorithm</li>
<li>That session management is important</li>
</ul>
</div>
</section>

<section id="outline-container-org3d993ce" class="outline-2">
<h2 id="org3d993ce">Solution</h2>
<div class="outline-text-2" id="text-org3d993ce">
<p>
The description of the challenge already gives a big hint.
</p>

<blockquote>
<p>
Can you find a way to get into the Naughty List Management System as an admin?
</p>
</blockquote>

<p>
This implies that there is some form of authentication or authorization mechanism to be bypassed. This is also a rabbit hole; there is no way to log in as an admin. But there is no way given to find a username or password.
</p>


<figure id="org2c9da42">
<img src="index_att/login.png" alt="login.png">

<figcaption><span class="figure-number">Figure 1: </span>The new login screen</figcaption>
</figure>

<p>
Trying anything will result in an error message. It reads <i>Hey user your password is incorrect</i>. Unless you entered the user <i>user</i> you might find it odd that it is listed. It actually is a password reminder and does show the working username / password combination.
</p>


<figure id="orgea65f34">
<img src="index_att/error.png" alt="error.png">

<figcaption><span class="figure-number">Figure 2: </span>Authentication failure message</figcaption>
</figure>

<p>
Logging in with the username <code>user</code> and password <code>incorrect</code> will lead to an empty page. It literally says that the naughty list is currently empty. However, remember that the description was to login in as an admin user, perhaps there is a way to escalate privilege?
</p>


<figure id="orga4321b2">
<img src="index_att/empty-list.png" alt="empty-list.png">

<figcaption><span class="figure-number">Figure 1: </span>Logged in successfully as user</figcaption>
</figure>

<p>
Looking around the application will yield nothing useful. The DevTools (F12), however, have something in the cookies. A field called <code>token</code> has an entry that starts with <code>eyJ</code>.  Remember, from <a href="./../challenge-2/index.html">Challenge 2</a> that an encoded JSON structure will always start with <code>eyJ</code>. 
</p>


<figure id="orgc05575a">
<img src="index_att/console.png" alt="console.png">

<figcaption><span class="figure-number">Figure 1: </span>A token in the cookies</figcaption>
</figure>

<p>
Retrieving the full text shows the following Base64 string. It is a little bit different though, as there are <code>.</code> between segments. Throw it into CyberChef to fully decode it, either with <i>From Base64</i> or <i>From JWT</i> (the latter does not always work for me).
</p>

<blockquote>
<p>
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdXRoIjoxMDk2MSwidGV4dCI6IkkgZG8gbG92ZSB
hIGdvb2QgcHV6emxlLiIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNjA3MzY5NDU3fQ.yWR9bJ8F6E6_V3z
krl7K85_pELFfR0AfuJlObepU9XQ
</p>
</blockquote>

<p>
Once it is clear that it is a JSON Web Token (or JWT for short) it is also possible to use a specialized tool to work with it. The below screenshot shows the entire token in <a href="https://jwt.io">The JWT Debugger</a>. I used it here to show the different parts based on colors.
</p>


<figure id="orgdd1071a">
<img src="index_att/jwt-io.png" alt="jwt-io.png">

<figcaption><span class="figure-number">Figure 1: </span>The token in the JWT debugger</figcaption>
</figure>

<p>
Searching the internet for vulnerabilities related to JWT tokens will eventually bring you to an  <a href="https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/">Auth0 article</a> that details the <code>NONE</code> algorithm. It was an early failure in JWT in which an attacker changes the algorithm of a token to <code>NONE</code>, removes the signature, and updates data to its liking. As there is no algorithm to verify the integrity of the data, the new token is accepted as a valid token. 
</p>

<p>
Using this approach the token can be manipulated. Below is the listing of the original token. When you try it a few times it becomes clear that <code>auth</code> in the payload is actually an incrementing number. This is the session id for the user. Only tokens for the correct session are accepted, so this operation has to be performed correctly, else the session will reset.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>The original content of the JWT</label><pre class="src src-javascript">{<span class="org-string">"typ"</span>:<span class="org-string">"JWT"</span>,<span class="org-string">"alg"</span>:<span class="org-string">"HS256"</span>}
.
{<span class="org-string">"auth"</span>:10961,<span class="org-string">"text"</span>:<span class="org-string">"I do love a good puzzle."</span>,<span class="org-string">"role"</span>:<span class="org-string">"user"</span>,<span class="org-string">"iat"</span>:1607369457}
.
SIGNATURE GARBLED DATA
</pre>
</div>

<p>
In the payload the <code>role</code> has to be changed from <code>user</code> to <code>admin</code>. This will cause the user to escalate privilege. The signature part can entirely be removed as the <code>alg</code> can be set to <code>NONE</code>. The 2nd <code>.</code> is important however, so make sure it remains.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>The malicious content of the JWT token</label><pre class="src src-javascript">{<span class="org-string">"typ"</span>:<span class="org-string">"JWT"</span>,<span class="org-string">"alg"</span>:<span class="org-string">"NONE"</span>}
.
{<span class="org-string">"auth"</span>:10961,<span class="org-string">"text"</span>:<span class="org-string">"I do love a good puzzle."</span>,<span class="org-string">"role"</span>:<span class="org-string">"admin"</span>,<span class="org-string">"iat"</span>:1607369457}
.
</pre>
</div>

<p>
This new token has to be Base64 encoded again. An important thing to note is that JWT tokens do not allow the <code>=</code> character to be used, the padding has to be removed to form a valid token.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>All parts of the JWT token encoded</label><pre class="src src-text">eyJ0eXAiOiJKV1QiLCJhbGciOiJOT05FIn0
.
eyJhdXRoIjoxMDk2MSwidGV4dCI6IkkgZG8gbG92ZSBhIGdvb2QgcHV6emxlLiIsInJvbGUiOiJhZG1pbiIs
ImlhdCI6MTYwNzM2OTQ1N30
.
</pre>
</div>

<p>
Putting all the pieces back together will yield a new valid JWT token. This token elevates the privilege to <code>admin</code> for this specific session and removes the signature check. Put it back into the cookie using the DevTools.
</p>

<blockquote>
<p>
eyJ0eXAiOiJKV1QiLCJhbGciOiJOT05FIn0.eyJhdXRoIjoxMDk2MSwidGV4dCI6IkkgZG8gbG92ZSBh
IGdvb2QgcHV6emxlLiIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTYwNzM2OTQ1N30.
</p>
</blockquote>

<p>
Reloading the page will reveal the flag.
</p>


<figure id="org16a425f">
<img src="index_att/flag.png" alt="flag.png">

<figcaption><span class="figure-number">Figure 1: </span>Elevated privilige, the flag</figcaption>
</figure>

<p>
Grab your points and your badge.
</p>

<p>
<img src="index_att/badge.png" alt="badge.png">
Go back to the <a href="../../../index.html">homepage</a>.
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<p class="author">Author: Arjen Wiersma</p>
<p class="date">Created: 21 Dec. 2022</p>
</footer>
</body>
</html>