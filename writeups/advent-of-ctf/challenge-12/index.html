<!DOCTYPE html>
<html lang="en">
<head>
<!-- 21 Dec. 2022 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advent of CTF - Challenge 12</title>
<meta name="author" content="Arjen Wiersma" />
<meta name="generator" content="Org Mode" />
<meta description='Writings by Arjen'/>
<link rel='alternate' type='application+rss/xml' title='Writings by Arjen' href='/posts/rss.xml'/>
<link rel="stylesheet" href="../../../css/theme.css?v=20216e086cf8a20ead56908f3be0bcda6af2531ec1a68c9058ee7495590f57ea" type="text/css">
</head>
<body>
<main id="content" class="content">
<header>
<h1 class="title">Advent of CTF - Challenge 12</h1>
<p class="subtitle" role="doc-subtitle">&ldquo;Command&rdquo;</p>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf39d851">Challenge</a></li>
<li><a href="#orge7d1828">Solution</a></li>
</ul>
</div>
</nav>

<section id="outline-container-orgf39d851" class="outline-2">
<h2 id="orgf39d851">Challenge</h2>
<div class="outline-text-2" id="text-orgf39d851">
<p>
The challenge focuses on the ability to extract data from an environment using a command injection.
</p>

<p>
What you will learn:
</p>

<ul class="org-ul">
<li>Identifying a command injection</li>
<li>Using shell processing to execute commands</li>
<li>Redirect command output</li>
</ul>
</div>
</section>

<section id="outline-container-orge7d1828" class="outline-2">
<h2 id="orge7d1828">Solution</h2>
<div class="outline-text-2" id="text-orge7d1828">
<p>
The challenge starts with a destination check. Apparently you can enter an IP address to check availability of the destination. The IP address is a hint due to its use in command injections. When you enter an IP address to check availability generally it will be passed to <code>ping</code> as an argument.
</p>


<figure id="orgf23a35a">
<img src="index_att/start.png" alt="start.png">

<figcaption><span class="figure-number">Figure 1: </span>Start of the challenge</figcaption>
</figure>

<p>
Entering any valid input will give a timestamp together with an <i>Destination check was OK</i>. 
</p>


<figure id="org49a0a28">
<img src="index_att/valid-input.png" alt="valid-input.png">

<figcaption><span class="figure-number">Figure 2: </span>Entering valid input</figcaption>
</figure>

<p>
However, when you enter something that breaks a command line as a <code>'</code>, an errormessage is displayed. It makes clear that the command is being executed using <code>bash</code>. The only real output that has been noticeable up to now has been error messages. On a unix system the error messages are printed on <code>STDERR</code>.  
</p>


<figure id="org0c07c89">
<img src="index_att/error.png" alt="error.png">

<figcaption><span class="figure-number">Figure 1: </span>Forcing an error message</figcaption>
</figure>

<p>
Given the idea that messages on <code>STDERR</code> are being displayed it stands to reason that the user might be able to execute commands and see their output by redirecting to <code>STDERR</code>. The default way to do this in Linux is to use <code>1&gt;&amp;2</code>. However trying this will result in <i>2: Permission denied</i>. From the message it seems that the <code>&amp;</code> has been stripped and the command was translated to <code>1&gt;2</code>, which would write <code>1</code> to the file <code>2</code>, which is not permitted. This method can be used to check what characters are filtered or not. After some testing it seems the following are filtered: <code>&amp;;-`|</code>
</p>


<figure id="orga79a775">
<img src="index_att/output-redirect.png" alt="output-redirect.png">

<figcaption><span class="figure-number">Figure 1: </span>Redirecting output</figcaption>
</figure>

<p>
However, there is a special device called <code>/dev/stderr</code> that will do the same thing; writing to <code>/dev/stderr</code> will result in the text on <code>STDERR</code> and thus an error message will be displayed. From the text it is clear that the application uses <code>nslookup</code> to do a check.
</p>


<figure id="org47edf93">
<img src="index_att/output-redirect-stderr.png" alt="output-redirect-stderr.png">

<figcaption><span class="figure-number">Figure 1: </span>Redirecting using stderr</figcaption>
</figure>

<p>
The problem now is that, in order to get the flag a command like <code>cat</code> is required to read it. But all characters that normally will give an additional command execution are filtered out. During the filter check it was clear that the <code>$</code> was not filtered however. This can be used to create shell expansions: <code>$()</code>. By using <code>$(ls &gt; /dev/stderr)</code> the findings can be combined to perform a shell expansion, which executes the command and gives the result back to the calling command line. The result is not that important, only the execution in the shell expansion. 
</p>


<figure id="org009e3d2">
<img src="index_att/stderr.png" alt="stderr.png">

<figcaption><span class="figure-number">Figure 1: </span>Using /dev/stderr for redirection</figcaption>
</figure>

<p>
Using this trick, the contents of the file <code>/flag.txt</code> can be read into <code>/dev/stderr</code> to reveal the flag.
</p>


<figure id="orgf93437f">
<img src="index_att/flag.png" alt="flag.png">

<figcaption><span class="figure-number">Figure 1: </span>Flag</figcaption>
</figure>

<p>
With that the puzzle is solved and the points can be retrieved. Do not forget to grab the badge as well!
</p>


<figure id="orgcc7b463">
<img src="index_att/badge.png" alt="badge.png">

<figcaption><span class="figure-number">Figure 1: </span>The badge</figcaption>
</figure>


<p>
Go back to the <a href="../../../index.html">homepage</a>.
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<p class="author">Author: Arjen Wiersma</p>
<p class="date">Created: 21 Dec. 2022</p>
</footer>
</body>
</html>