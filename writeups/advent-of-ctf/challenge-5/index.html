<!DOCTYPE html>
<html lang="en">
<head>
<!-- 21 Dec. 2022 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advent of CTF - Challenge 5</title>
<meta name="author" content="Arjen Wiersma" />
<meta name="generator" content="Org Mode" />
<meta description='Writings by Arjen'/>
<link rel='alternate' type='application+rss/xml' title='Writings by Arjen' href='/posts/rss.xml'/>
<link rel="stylesheet" href="../../../css/theme.css?v=20216e086cf8a20ead56908f3be0bcda6af2531ec1a68c9058ee7495590f57ea" type="text/css">
</head>
<body>
<main id="content" class="content">
<header>
<h1 class="title">Advent of CTF - Challenge 5</h1>
<p class="subtitle" role="doc-subtitle">&ldquo;Classic&rdquo;</p>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org1e3e0a0">Challenge</a></li>
<li><a href="#org136dec5">Solution 1 - Using the injection</a></li>
<li><a href="#org9e1f1ba">Solution 2 - Extracting through the error message</a></li>
</ul>
</div>
</nav>

<section id="outline-container-org1e3e0a0" class="outline-2">
<h2 id="org1e3e0a0">Challenge</h2>
<div class="outline-text-2" id="text-org1e3e0a0">
<p>
Today&rsquo;s challenge is a <code>SQL Injection</code>. A spin on the classing injection that is posted on just about every tutorial website.
</p>

<p>
What you will learn today:
</p>

<ul class="org-ul">
<li>Discover of SQL Injections</li>
<li>Deducing SQL queries</li>
<li>Manipulating SQL queries</li>
</ul>
</div>
</section>

<section id="outline-container-org136dec5" class="outline-2">
<h2 id="org136dec5">Solution 1 - Using the injection</h2>
<div class="outline-text-2" id="text-org136dec5">
<p>
In this challenge, again, you are faced with a login screen. This time no trickery with cookies or other browser based things however.
</p>


<figure id="org8b2101f">
<img src="index_att/login.png" alt="login.png">

<figcaption><span class="figure-number">Figure 1: </span>The familiar login screen</figcaption>
</figure>

<p>
The description of the challenge reads as follows.
</p>

<blockquote>
<p>
Again a login form stands in your way. What powerful &rsquo;hacker&rsquo; tool will help you proceed?
</p>
</blockquote>

<p>
The clue in this description is the use of the <code>'</code>. This is a hint to the presence of a SQL injection. If the <code>'</code> is entered as a username of password (but not both) then a SQL error will occur. 
</p>


<figure id="orgdef3a83">
<img src="index_att/sql_error.png" alt="sql_error.png">

<figcaption><span class="figure-number">Figure 2: </span>SQL error</figcaption>
</figure>

<p>
Taking the information from the screen it is clear that the backend database is a <code>MariaDB</code> server, which is a spinoff of the <code>MySQL</code> database. And there is only a little bit of extra information, in the form of the username that was entered. In this case it was <code>test'</code>.
</p>

<blockquote>
<p>
Error description: You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &rsquo;test&rsquo;&rsquo; at line 1 
</p>
</blockquote>

<p>
Exploring common SQL injections it is clear that we also need to use comments. You can either use <code>--</code> or <code>#</code> as a comment sign. The big difference is that with <code>--</code> you need to ensure a space is left behind it, with the <code>#</code> a space is not mandatory.
</p>

<p>
To fully understand the impact of the vulnerability it helps to have the original SQL statement. The following listing is the SQL as used in the code. PHP will further check to see if the <code>count</code> equals 1 before proceeding. As an attacker this is unknown and has to be deduced from behaviour.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>The SQL query used in the code</label><pre class="src src-sql"><span class="org-keyword">SELECT</span> <span class="org-builtin">count</span>(*)
  <span class="org-keyword">FROM</span> users
 <span class="org-keyword">WHERE</span> username=<span class="org-string">'$username'</span>
   <span class="org-keyword">AND</span> password=<span class="org-string">'$password'</span>
</pre>
</div>

<p>
Given the code above the most common injection that you will find will be the following listing, however that will not work as the count will be 2, given that there are multiple accounts in the database.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Common SQL injection</label><pre class="src src-sql"><span class="org-string">' or 1=1 #</span>
</pre>
</div>

<p>
The first option to solve this is to know a username and use that. For instance, it is the <code>Administrator</code> login page, so a username of <code>admin</code> is not far fetched. A payload such as <code>admin' #</code> would yield a value of 1 for the count and will give the flag.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>SQL payload applied</label><pre class="src src-sql"><span class="org-keyword">SELECT</span> <span class="org-builtin">count</span>(*)
  <span class="org-keyword">FROM</span> users
 <span class="org-keyword">WHERE</span> username=<span class="org-string">'admin'</span> <span class="org-comment">-- AND password='something'</span>
</pre>
</div>

<p>
But that means you need to guess a username. That is not really fun of course. An alternative way would be to add conditions to the query that result in the same behavior. An example would be to do the following query <code>' OR username like 'a%' #</code>. The only guess here is that a username might start with an <code>a</code>, which is not unreasonable.
</p>



<figure id="org1efc01c">
<img src="index_att/flag.png" alt="flag.png">

<figcaption><span class="figure-number">Figure 1: </span>The flag</figcaption>
</figure>

<p>
As always, be sure to grab the badge as well.
</p>


<figure id="org9c011e2">
<img src="index_att/badge.png" alt="badge.png">

<figcaption><span class="figure-number">Figure 1: </span>The badge for today</figcaption>
</figure>
</div>
</section>

<section id="outline-container-org9e1f1ba" class="outline-2">
<h2 id="org9e1f1ba">Solution 2 - Extracting through the error message</h2>
<div class="outline-text-2" id="text-org9e1f1ba">
<p>
Another way would be to use the error message as a vessel to extract information. <a href="https://maik.dev/posts/2020/12/challenge-5-adventofctf/">Maik</a> wrote a great blog post on this challenge from that perspective. I have recreated the instructions here below.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Error extracting SQL query</label><pre class="src src-sql"><span class="org-string">' AND (SELECT 1 FROM</span>
<span class="org-string">         (SELECT COUNT(*),</span>
<span class="org-string">                 CONCAT(</span>
<span class="org-string">                    (SELECT database()),</span>
<span class="org-string">                    0x3a,</span>
<span class="org-string">                    FLOOR(RAND(0)*2)) x</span>
<span class="org-string">            FROM information_schema.tables GROUP BY x)</span>
<span class="org-string">         y) #</span>
</pre>
</div>

<p>
This is quite the payload. First the query has to return something, in this case it will return <code>1</code> from the table <code>y</code>. This table does not exist (yet), but for every row in <code>y</code> it would return <code>1</code>. In the case of the payload this does not actually do anything, as the payload will force an error.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Error extracting SQL query</label><pre class="src src-sql"><span class="org-string">' AND (SELECT 1 FROM y) #</span>
</pre>
</div>

<p>
The <code>y</code> table is built using a sub query.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Table subquery</label><pre class="src src-sql"><span class="org-keyword">SELECT</span> <span class="org-builtin">COUNT</span>(*),
       CONCAT(
         (<span class="org-keyword">SELECT</span> database()),
         0x3a,
         FLOOR(RAND(0)*2)
       ) x
  <span class="org-keyword">FROM</span> information_schema.tables
 <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> x
</pre>
</div>

<p>
The <code>y</code> table will be constructed by taking a <code>count(*)</code>, which will be the number of times the 2nd column occurs in the result set. The 2nd column is a <code>CONCAT</code>, a string concatenation, of yet another sub query, in this case <code>SELECT database()</code>, the hex value <code>0x3a</code> (ascii character <code>:</code>) and a random value <code>0</code> or <code>1</code>.
</p>

<p>
The sub query <code>SELECt database()</code> is the column of data that is to be extracted. The string concatenation with the random value will keep creating new rows for every row in the table it is queried from, in this case the <code>information_schema.tables</code>. It is important that the sub query (<code>select database()</code>) returns a single value and that the table it is used against has at least 3 rows so that a duplicate key will be created.
</p>

<p>
So, in order to see what tables are part of the schema the <code>information_schema.tables</code> table can be queries with a <code>LIMIT</code> keyword to only return a single row.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Payload to extract tables names</label><pre class="src src-sql"><span class="org-string">' AND (SELECT 1 FROM (</span>
<span class="org-string">SELECT COUNT(*),</span>
<span class="org-string">       CONCAT(</span>
<span class="org-string">         (SELECT table_name</span>
<span class="org-string">            FROM information_schema.tables</span>
<span class="org-string">           WHERE table_schema='</span>testdb<span class="org-string">' LIMIT 0,1),</span>
<span class="org-string">         0x3a,</span>
<span class="org-string">         FLOOR(RAND(0)*2)</span>
<span class="org-string">       ) x</span>
<span class="org-string">  FROM information_schema.tables</span>
<span class="org-string"> GROUP BY x)</span>
<span class="org-string">         y) #</span>
</pre>
</div>

<p>
The result will be:
</p>

<blockquote>
<p>
Error description: Duplicate entry &rsquo;users:1&rsquo; for key &rsquo;group_key&rsquo; 
</p>
</blockquote>

<p>
Using this technique the <code>users</code> table can be exfiltrated giving a username and password and the challenge is solved.
</p>

<p>
Go back to the <a href="../../../index.html">homepage</a>.
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<p class="author">Author: Arjen Wiersma</p>
<p class="date">Created: 21 Dec. 2022</p>
</footer>
</body>
</html>