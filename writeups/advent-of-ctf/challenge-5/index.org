#+TITLE: Advent of CTF - Challenge 5
#+SUBTITLE: "Classic"

* Challenge

Today's challenge is a =SQL Injection=. A spin on the classing injection that is posted on just about every tutorial website.

What you will learn today:

- Discover of SQL Injections
- Deducing SQL queries
- Manipulating SQL queries

* Solution
:PROPERTIES:
:ATTACH_DIR: /home/arjen/Projects/credmp.github.io/writeups/advent-of-ctf/challenge-5/index_att
:END:

In this challenge, again, you are faced with a login screen. This time no trickery with cookies or other browser based things however.

#+CAPTION: The familiar login screen
[[file:index_att/login.png]]

The description of the challenge reads as follows.

#+begin_quote
Again a login form stands in your way. What powerful 'hacker' tool will help you proceed?
#+end_quote

The clue in this description is the use of the ='=. This is a hint to the presence of a SQL injection. If the ='= is entered as a username of password (but not both) then a SQL error will occur. 

#+CAPTION: SQL error
[[file:index_att/sql_error.png]]

Taking the information from the screen it is clear that the backend database is a =MariaDB= server, which is a spinoff of the =MySQL= database. And there is only a little bit of extra information, in the form of the username that was entered. In this case it was =test'=.

#+begin_quote
Error description: You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near 'test'' at line 1 
#+end_quote

Exploring common SQL injections it is clear that we also need to use comments. You can either use =--= or =#= as a comment sign. The big difference is that with =--= you need to ensure a space is left behind it, with the =#= a space is not mandatory.

To fully understand the impact of the vulnerability it helps to have the original SQL statement. The following listing is the SQL as used in the code. PHP will further check to see if the =count= equals 1 before proceeding. As an attacker this is unknown and has to be deduced from behaviour.

#+CAPTION: The SQL query used in the code
#+begin_src sql 
SELECT count(*)
  FROM users
 WHERE username='$username'
   AND password='$password'
#+end_src

Given the code above the most common injection that you will find will be the following listing, however that will not work as the count will be 2, given that there are multiple accounts in the database.

#+CAPTION: Common SQL injection
#+begin_src sql
' or 1=1 #
#+end_src

The first option to solve this is to know a username and use that. For instance, it is the =Administrator= login page, so a username of =admin= is not far fetched. A payload such as =admin' #= would yield a value of 1 for the count and will give the flag.

#+CAPTION: SQL payload applied
#+begin_src sql 
SELECT count(*)
  FROM users
 WHERE username='admin' -- AND password='something'
#+end_src

But that means you need to guess a username. That is not really fun of course. An alternative way would be to add conditions to the query that result in the same behavior. An example would be to do the following query =' OR username like 'a%' #=. The only guess here is that a username might start with an =a=, which is not unreasonable.

Another way would be to use the error message as a vessel to extract information. [[https://maik.dev/posts/2020/12/challenge-5-adventofctf/][Maik]] wrote a great blog post on this challenge from that perspective.

#+CAPTION: The flag
[[file:index_att/flag.png]]

As always, be sure to grab the badge as well.

#+CAPTION: The badge for today
[[file:index_att/badge.png]]

Go back to the [[../../../index.org][homepage]].
