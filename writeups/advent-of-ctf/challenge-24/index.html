<!DOCTYPE html>
<html lang="en">
<head>
<!-- 21 Dec. 2022 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advent of CTF - Challenge 24</title>
<meta name="author" content="Arjen Wiersma" />
<meta name="generator" content="Org Mode" />
<meta description='Writings by Arjen'/>
<link rel='alternate' type='application+rss/xml' title='Writings by Arjen' href='/posts/rss.xml'/>
<link rel="stylesheet" href="../../../css/theme.css?v=20216e086cf8a20ead56908f3be0bcda6af2531ec1a68c9058ee7495590f57ea" type="text/css">
</head>
<body>
<main id="content" class="content">
<header>
<h1 class="title">Advent of CTF - Challenge 24</h1>
<p class="subtitle" role="doc-subtitle">&ldquo;Final Battle&rdquo;</p>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgab3d0c4">Challenge</a></li>
<li><a href="#org4c2f303">Solution</a></li>
</ul>
</div>
</nav>

<section id="outline-container-orgab3d0c4" class="outline-2">
<h2 id="orgab3d0c4">Challenge</h2>
<div class="outline-text-2" id="text-orgab3d0c4">
<p>
The end of the Advent of CTF is here. A last battle remains for the honor of Santa.
</p>

<p>
What you will learn today:
</p>

<ul class="org-ul">
<li>The basics of a blockchain</li>
</ul>
</div>
</section>

<section id="outline-container-org4c2f303" class="outline-2">
<h2 id="org4c2f303">Solution</h2>
<div class="outline-text-2" id="text-org4c2f303">
<p>
The challenge starts out just like <a href="./../challenge-20/index.html">challenge 20</a>, with a small difference. In the footer it now says <code>Blockchain? True</code>.
</p>


<figure id="orgb7e4a7a">
<img src="index_att/challenge-start.png" alt="challenge-start.png">

<figcaption><span class="figure-number">Figure 1: </span>Start of the challenge</figcaption>
</figure>

<p>
In the source of the index page there are some development notes that will help in solving this challenge. They basically explain the way the board is hashed for use in the blockchain.
</p>


<figure id="org2a2539b">
<img src="index_att/dev-notes.png" alt="dev-notes.png">

<figcaption><span class="figure-number">Figure 2: </span>Development notes</figcaption>
</figure>

<p>
Using the same technique as used in the challenge 20 the stored game state can be read.
</p>


<figure id="org3f2dc27">
<img src="index_att/game-state.png" alt="game-state.png">

<figcaption><span class="figure-number">Figure 1: </span>The game state</figcaption>
</figure>

<p>
The game state is now significantly larger then before. Most of it is due to the key <code>chain</code>, which is the blockchain.
</p>

<p>
A blockchain works by taking a known value, a <code>hash</code> that has been previously computed, then taking a computation over the thing that is in the <code>block</code>, generally also a hash, and then combining these 2 values to compute a new hash. So, if we start with the hash <code>A</code> and then compute a hash for our block <code>B</code> the resulting hash will be that of <code>A+B</code>, which will then be passed on to the next block. The block, <code>C</code>, will then take its own hash and combine it with the previous hash to form a new one <code>A+B+C</code>. The chain is only valid if all hashes are correct, meaning it is impossible to change a single block, without recomputing all hashes.
</p>

<p>
Luckily we have the computation logic from the index page:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>The blockchain logic</label><pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">hash_string</span>(string):
    <span class="org-keyword">return</span> hashlib.md5(string.encode(<span class="org-string">'utf-8'</span>)).hexdigest()

<span class="org-keyword">def</span> <span class="org-function-name">hash_row</span>(row):
    <span class="org-variable-name">conv</span> = <span class="org-keyword">lambda</span> i : i <span class="org-keyword">or</span> <span class="org-string">' '</span>
    <span class="org-variable-name">res</span> = [conv(i) <span class="org-keyword">for</span> i <span class="org-keyword">in</span> row]
    <span class="org-keyword">return</span> hash_string(<span class="org-string">' '</span>.join(res))

<span class="org-keyword">def</span> <span class="org-function-name">hash_board</span>(board):
    <span class="org-variable-name">acc</span> = <span class="org-string">""</span>
    <span class="org-keyword">for</span> row <span class="org-keyword">in</span> board:
        <span class="org-variable-name">acc</span> += hash_row(row)
    <span class="org-keyword">return</span> acc

<span class="org-keyword">def</span> <span class="org-function-name">verify_chain</span>(game):
    <span class="org-variable-name">board</span>=game[<span class="org-string">"board"</span>]
    <span class="org-variable-name">chain</span> = game[<span class="org-string">"chain"</span>]

    <span class="org-keyword">if</span> <span class="org-builtin">len</span>(chain) &gt; 0:
        <span class="org-keyword">if</span> board != chain[-1][<span class="org-string">"board"</span>]:
            <span class="org-keyword">return</span> <span class="org-constant">False</span>

    <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(<span class="org-builtin">len</span>(chain)):
        <span class="org-variable-name">block</span>=chain[i]
        <span class="org-variable-name">h</span> = hash_board(block[<span class="org-string">"board"</span>])
        <span class="org-variable-name">h</span> = hash_string(h + block[<span class="org-string">"prev"</span>])
        <span class="org-keyword">if</span> h != block[<span class="org-string">"hash"</span>]:
            <span class="org-keyword">return</span> <span class="org-constant">False</span>
    <span class="org-keyword">return</span> <span class="org-constant">True</span>
</pre>
</div>

<p>
From the function <code>verify_chain</code> it is clear that the last entry of the chain has to be the current board state for it to pass inspection. From there the length of the chain is iterated to calculate and compare the hashes. Note that the <code>verify_chain</code> function does not check to see how many entries should be on the chain itself.
</p>

<p>
So, from this logic it is clear that a new game state can be created that only has 1 entry in the blockchain, the winning board, and that only that entry will require a new hash calculation. Luckily all the elements needed to do the calculation were given.
</p>

<p>
Working from the previous solution the following script will create a new payload.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Calculating the payload</label><pre class="src src-python"><span class="org-keyword">import</span> base64
<span class="org-keyword">import</span> pickle
<span class="org-keyword">import</span> hashlib

<span class="org-variable-name">data</span>=<span class="org-string">"gASVGQMAAAAAAAB9lCiMBWJvYXJklF2UKF2UKIwBT5RoBE5lXZQoaASMAViUaAZlXZQoTmgGaAZlZYwEdHVybpRoBIwIZmluaXNoZWSUiYwGd2lubmVylIwAlIwEc2FuZZSIjApibG9ja2NoYWlulIiMBWNoYWlulF2UKH2UKIwFYm9hcmSUXZQoXZQoTk5OZV2UKE5OTmVdlChOTmgGZWWMBHByZXaUjCBjZWYyMTVjNWJlOGNmNjNmY2YzZDQzZWNmMjUxMGIzM5SMBGhhc2iUjCBlN2RjOGUxZjdhNjc4OGJjMGNiNjg0MTUzOGIyMTZlOJR1fZQojAVib2FyZJRdlChdlChoBE5OZV2UKE5OTmVdlChOTmgGZWWMBHByZXaUaBmMBGhhc2iUjCBmYzkzMjM2YjVlZWE1ZjFkNTVlMmI1YjMwOGQ2NzM5MJR1fZQojAVib2FyZJRdlChdlChoBE5OZV2UKE5oBk5lXZQoTk5oBmVljARwcmV2lGgijARoYXNolIwgYThkYzBkM2RhMjkwZDFlODk0ZWFhZmZjYjk4Mzk4YzmUdX2UKIwFYm9hcmSUXZQoXZQoaARoBE5lXZQoTmgGTmVdlChOTmgGZWWMBHByZXaUaCuMBGhhc2iUjCBlNzRmNWIyMmY1MjEzYmE0YzI0NDk3NTljZTkxYzJhYZR1fZQojAVib2FyZJRdlChdlChoBGgETmVdlChOaAZoBmVdlChOTmgGZWWMBHByZXaUaDSMBGhhc2iUjCBlZjI1NTE0ZGZmYmY4MjQ3Y2ZmNjA2M2JlOTBmMmQ1NJR1fZQojAVib2FyZJRdlChdlChoBGgETmVdlChoBGgGaAZlXZQoTk5oBmVljARwcmV2lGg9jARoYXNolIwgZTNhNGMwMzdiZGYxNTRiMzQ0ZWQ5YmQxNjQzYTYyOWSUdX2UKIwFYm9hcmSUXZQoXZQoaARoBE5lXZQoaARoBmgGZV2UKE5oBmgGZWWMBHByZXaUaEaMBGhhc2iUjCBjMjQwZmExNjE3MzdjOTY3ZWNlNWZkOTQ2NzJhYjBmOJR1ZXUu"</span>

<span class="org-variable-name">game</span>=base64.b64decode(data)
<span class="org-variable-name">exploit</span>=pickle.loads(game)

<span class="org-variable-name">exploit</span>[<span class="org-string">"board"</span>]=[[<span class="org-string">'O'</span>, <span class="org-string">'O'</span>, <span class="org-string">'X'</span>], [<span class="org-string">'O'</span>, <span class="org-constant">None</span>, <span class="org-string">'X'</span>], [<span class="org-constant">None</span>, <span class="org-string">'X'</span>, <span class="org-string">'X'</span>]]
<span class="org-comment-delimiter"># </span><span class="org-comment">Take the last chain entry</span>
<span class="org-variable-name">last</span>=exploit[<span class="org-string">"chain"</span>][-1]

<span class="org-comment-delimiter"># </span><span class="org-comment">Reset the chain to empty</span>
<span class="org-variable-name">exploit</span>[<span class="org-string">"chain"</span>]=[]
<span class="org-comment-delimiter"># </span><span class="org-comment">Put a winning board in the saved last entry</span>
<span class="org-variable-name">last</span>[<span class="org-string">"board"</span>]=[[<span class="org-string">'O'</span>, <span class="org-string">'O'</span>, <span class="org-string">'X'</span>], [<span class="org-string">'O'</span>, <span class="org-constant">None</span>, <span class="org-string">'X'</span>], [<span class="org-constant">None</span>, <span class="org-string">'X'</span>, <span class="org-string">'X'</span>]]
<span class="org-comment-delimiter"># </span><span class="org-comment">Add the last entry to the now empty chain</span>
exploit[<span class="org-string">"chain"</span>].append(last)

<span class="org-keyword">def</span> <span class="org-function-name">hash_string</span>(string):
    <span class="org-comment-delimiter">#</span><span class="org-comment">print("HASH STRING: %s" % string)</span>
    <span class="org-keyword">return</span> hashlib.md5(string.encode(<span class="org-string">'utf-8'</span>)).hexdigest()

<span class="org-keyword">def</span> <span class="org-function-name">hash_row</span>(row):
    <span class="org-variable-name">conv</span> = <span class="org-keyword">lambda</span> i : i <span class="org-keyword">or</span> <span class="org-string">' '</span>
    <span class="org-variable-name">res</span> = [conv(i) <span class="org-keyword">for</span> i <span class="org-keyword">in</span> row]
    <span class="org-keyword">return</span> hash_string(<span class="org-string">' '</span>.join(res))

<span class="org-keyword">def</span> <span class="org-function-name">hash_board</span>(board):
    <span class="org-variable-name">acc</span> = <span class="org-string">""</span>
    <span class="org-keyword">for</span> row <span class="org-keyword">in</span> board:
        <span class="org-variable-name">acc</span> += hash_row(row)
    <span class="org-keyword">return</span> acc

<span class="org-comment-delimiter"># </span><span class="org-comment">Create a new hash for the board</span>
<span class="org-variable-name">h</span> = hash_board(exploit[<span class="org-string">"chain"</span>][-1][<span class="org-string">"board"</span>])
<span class="org-variable-name">h</span> = hash_string(h + exploit[<span class="org-string">"chain"</span>][-1][<span class="org-string">"prev"</span>])
<span class="org-comment-delimiter"># </span><span class="org-comment">Update the hash for the last chain entry</span>
exploit[<span class="org-string">"chain"</span>][-1][<span class="org-string">"hash"</span>]=h

<span class="org-keyword">print</span>( base64.b64encode(pickle.dumps(exploit)).decode(<span class="org-string">'utf-8'</span>))
</pre>
</div>

<p>
After you grab the flag also be sure to grab the badge!
</p>


<figure id="org885c021">
<img src="./index_att/badge.png" alt="badge.png">

<figcaption><span class="figure-number">Figure 1: </span>The badge</figcaption>
</figure>

<p>
Go back to the <a href="../../../index.html">homepage</a>.
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<p class="author">Author: Arjen Wiersma</p>
<p class="date">Created: 21 Dec. 2022</p>
</footer>
</body>
</html>